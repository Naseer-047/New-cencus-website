<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <script>// --- load data safely from localStorage ---
let lodData = JSON.parse(localStorage.getItem('censusList')) || [];

// If you still add static entries for demo (like your previous push), do it BEFORE building filters.
// e.g. lodData.push({ household: "Demo", district: "X", state: "Y", familyMembers: 4 });

// --- Build state -> district map (using Set to avoid duplicates) ---
const stateDistrictMap = {};
lodData.forEach(entry => {
  const state = entry.state || '';
  const district = entry.district || '';
  if (!stateDistrictMap[state]) stateDistrictMap[state] = new Set();
  if (district) stateDistrictMap[state].add(district);
});

// --- Populate State dropdown ---
const stateSelect = document.getElementById('stateFilter');
const districtSelect = document.getElementById('districtFilter');

if (stateSelect) {
  // add default "All States"
  stateSelect.innerHTML = '<option value="">All States</option>';
  Object.keys(stateDistrictMap).forEach(state => {
    const opt = document.createElement('option');
    opt.value = state;
    opt.textContent = state;
    stateSelect.appendChild(opt);
  });
}

// --- when state changes, update district options ---
function updateDistrictOptions() {
  const selectedState = stateSelect ? stateSelect.value : '';
  districtSelect.innerHTML = '<option value="">All Districts</option>';
  if (selectedState && stateDistrictMap[selectedState]) {
    // convert Set to Array and sort (optional)
    Array.from(stateDistrictMap[selectedState])
      .sort()
      .forEach(district => {
        const opt = document.createElement('option');
        opt.value = district;
        opt.textContent = district;
        districtSelect.appendChild(opt);
      });
  }
}

// --- render the table and compute total ---
function renderTable(data) {
  const container = document.querySelector('.tablea');
  if (!container) return;

  // create HTML for table
  let html = `
    <table>
      <tr>
        <th>Household Head Name</th>
        <th>District</th>
        <th>State</th>
        <th>No of Members</th>
      </tr>
  `;

  let total = 0;
  data.forEach(item => {
    const members = parseInt(item.familyMembers) || 0;
    total += members;

    // escape minimal risk values (simple replace); for production use a proper sanitizer
    const hh = String(item.household || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    const dist = String(item.district || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    const st = String(item.state || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');

    html += `
      <tr>
        <td class="trrr">${hh}</td>
        <td class="trrr">${dist}</td>
        <td class="trrr">${st}</td>
        <td class="trrr">${members}</td>
      </tr>
    `;
  });

  html += `</table>`;
  container.innerHTML = html;

  // update total count element
  const totalCount = document.getElementById('totalCount');
  if (totalCount) totalCount.innerText = total;
}

// --- filter function based on dropdown values ---
function filterData() {
  const selectedState = stateSelect ? stateSelect.value : '';
  const selectedDistrict = districtSelect ? districtSelect.value : '';

  const filtered = lodData.filter(item => {
    const stateMatch = !selectedState || item.state === selectedState;
    const districtMatch = !selectedDistrict || item.district === selectedDistrict;
    return stateMatch && districtMatch;
  });

  renderTable(filtered);
}

// --- wire up events ---
if (stateSelect) {
  stateSelect.addEventListener('change', () => {
    updateDistrictOptions();
    filterData();
  });
}

if (districtSelect) {
  districtSelect.addEventListener('change', filterData);
}

// --- initial render ---
renderTable(lodData);
</script>
</body>
</html>